---
title: "ozone_tree_canopy_LA"
output: html_document
date: "2023-12-05"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Research Question

What is the relationship between ozone concentrations and tree canopy cover by census tract in Los Angeles County? How do ozone concentrations vary seasonally?

## Significance

Ground-level ozone, a component of smog, is a harmful air pollutant linked to asthma, bronchitis, and other respiratory illnesses. It's formed mainly in urban areas from vehicle emissions. Gas-powered vehicles emit nitrogen oxides, which react with sunlight to photodissociate into nitrogen and a single oxygen molecule. Oxygen doesn't like to exist as a single molecule, so it quickly bonds with O~2~ in the air to to create O~3~, or ozone^1^. Without the presence of a stabilizing substance, ozone will continue to photodissociate into O and O~2~ and come back together like quarrelsome lovers over and over and over again. Trees play an interesting role in this relationship, both contributing to the formation and removal of ozone in the air^2^. Through the stomata on their leaves, trees filter air pollutants and emit volatile organic compounds (VOCs), which serve to attract pollinators or repel pests. The general rule of thumb is that the more fragrant the tree, the higher the emittance of VOCs. VOCs react with ground-level ozone and prevent further photodissocation, contributing to the formation of smog.

## Data

***CalEnviroScreen 4.0***

Released by the California Office of Environmental Health Hazards Assessment in 2021, CalEnviroScreen 4.0 maps environmental, socieconomic, and health indicators at the census tract level for California. The two variables used in my analysis are ozone, measured in parts per million (ppm), and traffic, measured in vehicles per hour (vehicles/hour). The ozone values are the daily maximum concentrations averaged over May through October from 2017-2019. Traffic volume in each census tract was collected in 2017.

***Tree Canopy Cover***

This dataset, created by Tree People and the Center for Urban Resilience, lists existing percent canopy cover in each census tract in LA County. The data was created using LiDAR to estimate the proportion of area in each census tract occupied by tree canopy. The data was last updated in 2021 and describes canopy cover for 2016.

***US EPA Air Quality System***

Using the EPA Air Quality System query, I retrieved daily ozone measurements from 13 monitors in LA County for the years 2017-2019 to conduct my time series analysis. These monitors collect the data used to assign ozone values to census tracts in CalEnviroScreen 4.0.

```{r, message = FALSE, include = FALSE}
# import packages
library(tidyverse)
library(here)
library(sf)
library(modelr)
library(knitr)
library(broom)
library(lubridate)
library(tmap)
library(tsibble)
library(feasts)
library(cowplot)

# disable scientific notation
options(scipen = 999)
```

```{r, message = FALSE, include = FALSE}
# read in tree canopy percentage by census tract
tree_canopy <- read_csv(here("data", "2016 Tree Canopy Cover Calculations_a.csv"))

# read in CalEnviroScreen 4.0
enviroscreen <- st_read(here("data", "calenviroscreen40shpf2021shp", "CES4 Final Shapefile.shp"), quiet = TRUE) %>% 
  filter(County == "Los Angeles")

# select variables of interest
enviroscreen <- enviroscreen %>% 
  select(Tract, Ozone, OzoneP, Traffic, TrafficP, Shape_Leng, Shape_Area, geometry) %>% 
  mutate(Traffic = na_if(Traffic, -999))

# make column names lowercase
names(enviroscreen) <- tolower(names(enviroscreen))

# merge the two dataframes
tracts_trees <- merge(enviroscreen, tree_canopy, by.x = "tract", by.y = "geoid20")
```

## Preliminary Data Analysis and Visualization

To prepare my data for linear regression, I first merged my CalEnviroScreen 4.0 and tree canopy cover datasets by census tract ID. During the merge, we lose around 350 census tracts due to mismatched IDs. IDs may have been updated between the different temporal ranges of our datasets. We're still left with measurements for ozone, traffic volume, and percent tree canopy cover in 2,016 census tracts, which is a large enough sample to conduct our linear regression.

Next, I explored my data to see if it meets the assumptions to conduct Ordinary Least Squares regression. Plotting the distribution of my dependent variable, we can see that ozone is not distributed normally. The distribution is bimodal. Since there's no major skew, we can't easily transform our data logarithmically.

```{r, fig.cap = "Figure 1: Histogram of ozone concentrations in LA County census tracts"}
# plot histogram to show distribution of ozone concentrations in census tracts
ggplot(enviroscreen) +
  geom_histogram(aes(x = ozone),
                 bins = 30,
                 color = "black",
                 fill = "seagreen") +
  labs(x = "ozone (ppm)",
       y = "count",
       title = "Ozone Concentration Frequency") +
  theme_bw()
```
Then, I plotted two scatterplots of my independent variables, traffic volume and percent tree canopy cover, against ozone concentrations
```{r, warning = FALSE, fig.cap = "Figure 2: Percent tree canopy cover (A) and traffic volume (B) plotted against ozone concentrations in census tracts in LA County. Regression line plotted to show correlation"}
# plot percent canopy cover against ozone
trees_scatter <- tracts_trees %>% 
  ggplot(aes(x = existing_canopy_pct, y = ozone)) +
  geom_point() +
  geom_smooth(method = "lm",
              color = "red",
              formula = y ~ x,
              se = FALSE) + 
  labs(x = "canopy cover (percent)",
       y = "ozone (ppm)") +
  theme_bw()

# plot traffic volume against ozone
traffic_scatter <- tracts_trees %>% 
  ggplot(aes(x = traffic, y = ozone)) +
  geom_point() +
  geom_smooth(method = "lm",
              color = "red",
              formula = y ~ x,
              se = FALSE) + 
  labs(x = "traffic (vehicles/hour)",
       y = "") +
  theme_bw()

# arrange the plots side-by-side
plot_grid(trees_scatter, traffic_scatter, labels = "AUTO")
```
By plotting a correlation line using `geom_smooth()` in our `ggplot` code, we notice a positive correlation between percent canopy cover and ozone concentrations, but no correlation between traffic volume and ozone. 

Before running our regression model, let's test for multicollinearity between our independent variables.

```{r}
# find correlation between traffic volume and percent tree canopy cover
print(paste("r:", round(cor(tracts_trees$traffic, tracts_trees$existing_canopy_pct, use = "na.or.complete"), digits = 3)))
```
There is almost no correlation between our independent variables, so let's add them to our model and conduct a multiple linear regression, predicting ozone concentrations with percent tree canopy cover and traffic volume.

```{r}
# regress ozone on canopy cover and traffic
trees_traffic_mod <- lm(ozone ~ existing_canopy_pct + traffic, data = tracts_trees)

summary(trees_traffic_mod)
```

-   Our intercept means that for census tracts with 0% canopy cover and no traffic, we expect to see ozone concentrations at .047 ppm.

-   Our B1 means that for each 1 percentage point increase in canopy cover, holding traffic constant, we expect to see ozone concentrations increase by .00027 ppm

-   Our B2 means that for each 1 vehicle per hour increase, holding canopy cover constant, we expect to see ozone concentrations increase by a tiny amount

-   Our Adjusted R\^2 tells us that around 7.7% of the variation in ozone in census tracts is explained by tree canopy cover and traffic.

-   However, we see that traffic has a p-value of .5, which means it has no statistically significant relationship with ozone concentrations, so let's take it out of our model

-   Now let's run a simple linear regression using tree canopy cover and ozone

```{r}
# regress ozone on canopy cover and traffic proximity
trees_ozone_mod <- lm(ozone ~ existing_canopy_pct, data = tracts_trees)

summary(trees_ozone_mod)
```

-   Our intercepts don't change all that much, but we can see that adding traffic did actually mechanically increase our R\^2 value a bit
-   For census tracts with 0% tree canopy cover, we expect to see ozone concentrations of .047 ppm
-   For each one percentage point increase in tree canopy cover, we expect to see ozone concentrations increase by .0003 ppm
-   Our output shows that although tree canopy cover only explains about 7.5% of the variation in ozone concentrations, there is a statistically significant relationship between our independent and dependent variables at a significance level of .001.
-   now lets plot our residuals and test for homoskedasticity

```{r}
# visualize our residuals to test the assumption that our errors are independently distributed
# save regression to our model
predictions <- tracts_trees %>% 
  add_predictions(trees_ozone_mod) %>% 
  mutate(residuals = ozone - pred)

# plot our residuals to see if they are normally distributed
ggplot(predictions,
       aes(x = residuals)) +
  geom_histogram(color = "black",
                 fill = "seagreen",
                 bins = 30) +
  theme_classic()
```

```{r}
# plot a q-q plot of our residuals
plot(trees_ozone_mod)
```

-   from the q-q plot and the histogram, we can see that our residuals don't follow a normal distribution

-   

-   scale-location: used to check the homoscedasticity of residuals (equal variance of residuals)

    -   ideally what we would see is these residuals spread seemingly randomly around a horizontal line

    -   what we do see is that the variance of the residuals at lower predicted values is much greater than the spread of residuals at higher predicted values

    -   so, essentially, the variance of our predicted variables are not constant as a function of predicted values, with larger variance at lower predicted values

    -   what could this effect be? - the omission of variables in our model- there are other factors that play into the formation of ozone, such as sunlight and temperature that may have a strong influence on ozone

-   what we do see is the

-   even if we log transform ozone, the residuals don't change much

    -   you shouldn't even transform bimodal data

-   

<!-- -->

-   so what happens when our residuals are not normally distributed?

```{r}
# check for homoscedasticity
# scatterplot of residuals against our dependent variable
ggplot(predictions, aes(x = pred, y = residuals)) +
  geom_point() +
  geom_smooth(se = FALSE,
              color = "red") +
  labs(x = "predicted ozone value (ppm)")
```

-   our residual variance is clearly not constant across the fitted values

```{r}
# visualize our residuals to test the assumption that our errors are independently distributed
# save regression to our model
predictions <- tracts_trees %>% 
  add_predictions(trees_ozone_mod) %>% 
  mutate(residuals = ozone - pred)

# plot our residuals to see if they are normally distributed
ggplot(predictions,
       aes(x = residuals)) +
  geom_histogram(color = "black",
                 fill = "seagreen",
                 bins = 30) +
  theme_classic()
```

Pt 2:

If we look at the distribution of ozone concentrations, you'll notice this strange binning. Why is this? Well let's dig into how this data was created

-   But I digress: slaying the kriging beast??

```{r}
# plot ozone concentrations
tracts_trees %>% 
  ggplot(aes(x = existing_canopy_pct, y = ozone)) +
  geom_point() +
  labs(x = "canopy cover (percent)",
       y = "ozone (ppm)") +
   geom_smooth(method = "lm",
              color = "red",
              formula = y ~ x,
              se = FALSE) + 
  theme_bw()
```

-   We notice this binning effect of our data. How can ozone, a continuous variable show so many repeated values in census tracts

-   well, ozone values were actually assigned to census tracts through kriging. data from monitoring stations is taken, and then they use kriging to assign the value of ozone at the centroid of a census tract to that census tract. For census tracts farther than 50 km of a station, the value for the nearest station was used. So what we might be seeing are census tracts far from a station being assigned the nearest value of a station, or that dropoff of the effectiveness of kriging

-   let's look at where these monitors are:

-   a quick regression digression: lifting the kriging veil

```{r}
# read in our monitors data
monitors_ca <- read_csv(here("data", "ca_ozone_2017.csv"))

# update column names
names(monitors_ca) <- names(monitors_ca) %>% 
  tolower() %>% 
  str_replace_all(" ", "_")

# simply get the locations of the monitors
monitor_locations <- monitors_ca %>% 
  group_by(site_latitude, site_longitude) %>% 
  summarize(count = n())

# turn into an sf object
monitor_locations <- st_as_sf(monitors_ca, 
                              coords = c("site_longitude", "site_latitude"),
                              crs = 4326)

# group_by site name
monitor_locations <- monitor_locations %>% 
  group_by(site_name) %>% 
  summarize(count = n())

# get la county buffer
la_county_buffer <- enviroscreen %>% 
  st_buffer(dist = 50000) %>% 
  st_union() %>%
  st_as_sf() %>%
  st_make_valid()

# transform one more time

la_county_buffer <- st_transform(la_county_buffer, crs = 4326)

# subset to find monitor locations that overlap with the buffer
viable_monitors <- monitor_locations[la_county_buffer, ]
```

```{r}
# get la county border
la_county_border <- enviroscreen %>% 
  st_buffer(10) %>% 
  st_union() %>% 
  st_sf()

# plot them together
ggplot() +
  geom_sf(data = viable_monitors, color = "red") +
  geom_sf(data = la_county_border, fill = NA) +
  theme_classic() +
  labs(title = "Viable Ozone Monitors for Kriging")
```

-   I don't know how you feel Tamma, but I think that could explain some of our binning of a continuous variable

Part 2: time series

-   so our ozone variable was created by averaging the daily 8 hour max ozone concentration over the months of may- october for 2017-2019, and then kriging

-   the assumption underlying this omission of the winter months is that ozone concentrations are generally higher in the summer

-   but I wanted to look at the strength of this seasonal component

```{r}
# read in our time-series ozone data
# LA ozone 2017
la_ozone_2017 <- read_csv(here("data", "la_ozone_2017.csv")) %>% 
    rename(ozone = "Daily Max 8-hour Ozone Concentration")

# LA ozone 2018
la_ozone_2018 <- read_csv(here("data", "la_ozone_2018.csv")) %>% 
    rename(ozone = "Daily Max 8-hour Ozone Concentration")

# LA ozone 2019
la_ozone_2019 <- read_csv(here("data", "la_ozone_2019.csv")) %>% 
    rename(ozone = "Daily Max 8-hour Ozone Concentration")

# rbind our CSVs together
ozone_3yr <- rbind(la_ozone_2017, la_ozone_2018, la_ozone_2019)

# clean up column names
names(ozone_3yr) <- names(ozone_3yr) %>% 
  tolower() %>% 
  str_replace_all(" ", "_")
```

-   this data describes

```{r}
# explore the data

length(unique(ozone_3yr$site_id))
```

-   we need to prep our time series data

```{r}
# replace slashes with hyphens
ozone_3yr$date <- ozone_3yr$date %>% 
  str_replace_all("/", "-")

# convert to a datetime object
ozone_3yr$date <- as_datetime(ozone_3yr$date, format = "%m-%d-%Y") 

ozone_3yr$date <- as_datetime(ozone_3yr$date) 

## 
# parse the month and the year
ozone_3yr <- ozone_3yr %>% 
  mutate(month = month(date, label = TRUE),
         year = year(date)) %>% 
  mutate(mo_yr = yearmonth(date))
  

# find the mean for each month
monthly_mean <- ozone_3yr %>% 
  group_by(mo_yr) %>% 
  summarize(daily_ozone_mean = mean(ozone, na.rm = TRUE)) %>% 
  as_tsibble(index = mo_yr)

# plot the monthly data
ggplot(monthly_mean,
       aes(x = mo_yr, y = daily_ozone_mean)) +
  geom_line() +
  theme_bw() +
  labs(x = "time",
       y = "monthly mean ozone",
       title = "LA County Monthly Mean Ozone Concentrations")

# plot daily data
ggplot(ozone_3yr,
       aes(x = date, y = ozone)) +
  geom_point(size = .5) 
```

-   

-   our plot indicates that there might be a seasonal component

    -   I think i should grab data from 2017-2019 (same timeframe as the cal enviroscreen)
    -   so lets decomp our time series data

```{r}
# decompose our time series
ozone_dcmp <- monthly_mean %>% 
  model(classical_decomposition(daily_ozone_mean, type = "additive"))


# plot the decomp components
components(ozone_dcmp) %>% 
  autoplot()
```

```{r}
# plot the lag components
acf(monthly_mean, lag.max = 12)
```

-   There a statistically significant, positive correlation between lag t and lags t-2, t-11, and t-12.

-   there is a statistically significant, negative correlation between lag t and lags t-5, t-6, t-7, and t-8.

-   What the prior research tells us is that ozone is higher in the summer due to increased temperature and sunlight, and now we can see the strength of the relationship

    -   our data for cal enviroscreen is attempting to assign a score to each census tract, so it makes sense that the winter months are left out- we are only looking at the highest values for ozone
